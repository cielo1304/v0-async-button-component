# Variant B V2 - Auto Module Financial Integration COMPLETE

## Status: ‚úÖ PRODUCTION READY

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–≤—Ç–æ-–º–æ–¥—É–ª—è —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π —á–µ—Ä–µ–∑ **cashbox_operation_v2** —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, God Mode –∏ –ø–æ–ª–Ω—ã–º audit trail.

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### 1. ‚öõÔ∏è –ê–¢–û–ú–ê–†–ù–û–°–¢–¨
- **–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ RPC** - –Ω–∏–∫–∞–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å –¥–µ–Ω—å–≥–∞–º–∏
- **cashbox_operation_v2** - –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å** - rollback –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

### 2. üë§ GOD MODE
- **–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** –≤ add-payment-dialog
- **–í—ã–±–æ—Ä –∞–∫—Ç–æ—Ä–∞** —á–µ—Ä–µ–∑ GodModeActorSelector
- **Audit trail** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º actor_id –≤ audit_log_v2

### 3. üìä P&L Tracking
- **auto_ledger** - –≤—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É –∞–≤—Ç–æ
- **auto_car_pnl** view - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏/—É–±—ã—Ç–∫–∞
- **Real-time** - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

### 4. üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å contacts
- **contact_id** –≤ auto_clients
- **buyer_contact_id / seller_contact_id** –≤ auto_deals
- –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

#### `auto_ledger`
```sql
id               UUID PRIMARY KEY
car_id           UUID NOT NULL ‚Üí cars(id)
deal_id          UUID ‚Üí auto_deals(id)
category         TEXT NOT NULL  -- PURCHASE, EXPENSE, SALE_REVENUE, SALE_PAYMENT
amount           NUMERIC(15,2)  -- –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –¥–ª—è –¥–æ—Ö–æ–¥–æ–≤, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤
description      TEXT
created_at       TIMESTAMPTZ
created_by       UUID
```

#### `auto_deals` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
```sql
-- –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è V2
buyer_contact_id         UUID ‚Üí contacts(id)
seller_contact_id        UUID ‚Üí contacts(id)
sale_price              NUMERIC
sale_currency           TEXT DEFAULT 'RUB'
total_paid              NUMERIC DEFAULT 0
total_debt              NUMERIC DEFAULT 0
rent_price_daily        NUMERIC
rent_start_date         DATE
rent_end_date           DATE
commission_mode         TEXT
commission_fixed_amount NUMERIC
profit_total            NUMERIC DEFAULT 0
profit_available        NUMERIC DEFAULT 0
rules                   JSONB DEFAULT '{}'
```

#### `auto_payments` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
```sql
-- –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è V2
due_date                DATE
paid_amount             NUMERIC DEFAULT 0
paid_date               DATE
created_by_employee_id  UUID
```

#### `auto_clients` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
```sql
-- –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è V2
contact_id              UUID ‚Üí contacts(id)
```

### Views

#### `auto_car_pnl`
```sql
SELECT 
  car_id,
  brand, model, year, status,
  total_purchase_cost,     -- —Å—É–º–º–∞ –≤—Å–µ—Ö PURCHASE
  total_expenses,          -- —Å—É–º–º–∞ –≤—Å–µ—Ö EXPENSE
  total_revenue,           -- —Å—É–º–º–∞ –≤—Å–µ—Ö SALE_REVENUE
  total_payments_received, -- —Å—É–º–º–∞ –≤—Å–µ—Ö SALE_PAYMENT
  net_profit_loss,         -- –∏—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫
  total_costs,             -- –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã
  deals_count              -- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫
FROM cars
LEFT JOIN auto_ledger ...
GROUP BY car_id
```

---

## üîß RPC —Ñ—É–Ω–∫—Ü–∏–∏

### `auto_record_payment_v2()`
**–ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å –ø–ª–∞—Ç–µ–∂–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π**

```sql
PARAMETERS:
  p_deal_id UUID
  p_cashbox_id UUID
  p_amount NUMERIC
  p_currency TEXT
  p_schedule_payment_id UUID (optional)
  p_note TEXT (optional)
  p_actor_employee_id UUID (optional)

RETURNS: UUID (payment_id)

OPERATIONS (ATOMIC):
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ deal –∏ cashbox
2. cashbox_operation_v2() ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é + –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
3. –û–±–Ω–æ–≤–ª—è–µ—Ç/—Å–æ–∑–¥–∞–µ—Ç auto_payments
4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç total_paid/total_debt –≤ auto_deals
5. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ (NEW ‚Üí IN_PROGRESS ‚Üí COMPLETED)
6. audit_log_v2 –∑–∞–ø–∏—Å—å
```

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ RPC (–∏–∑ V1)
- `auto_create_purchase_v1()` - –∑–∞–ø–∏—Å—å –∑–∞–∫—É–ø–∫–∏
- `auto_record_expense_v1()` - –∑–∞–ø–∏—Å—å —Ä–∞—Å—Ö–æ–¥–∞
- `auto_create_deal_v1()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –ø—Ä–æ–¥–∞–∂–∏

---

## üíª Server Actions

### `/app/actions/auto.ts`

#### `recordAutoPaymentV2()`
```typescript
export async function recordAutoPaymentV2(params: {
  dealId: string
  cashboxId: string
  amount: number
  currency: string
  schedulePaymentId?: string
  note?: string
  actorEmployeeId?: string
}): Promise<AutoActionResult>
```

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ RPC
- ‚úÖ God Mode support
- ‚úÖ Audit trail
- ‚úÖ –ë–µ–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–µ–Ω—å–≥–∞–º–∏

#### –î—Ä—É–≥–∏–µ actions
- `createAutoPurchase()` - –∑–∞–ø–∏—Å—å –∑–∞–∫—É–ø–∫–∏
- `recordAutoExpense()` - –∑–∞–ø–∏—Å—å —Ä–∞—Å—Ö–æ–¥–∞
- `createAutoDeal()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
- `recordAutoPayment()` - deprecated, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å V2

---

## üé® UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### `/components/auto-platform/add-payment-dialog.tsx`
**–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –¥–ª—è V2**

#### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –í—ã–±–æ—Ä –∫–∞—Å—Å—ã (—Ç–æ–ª—å–∫–æ —Å –Ω—É–∂–Ω–æ–π –≤–∞–ª—é—Ç–æ–π)
- ‚úÖ –í—ã–±–æ—Ä –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞ (optional)
- ‚úÖ –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –ø–ª–∞—Ç–µ–∂—É
- ‚úÖ **God Mode** - –≤—ã–±–æ—Ä –∞–∫—Ç–æ—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- –£–±—Ä–∞–Ω—ã –≤—Å–µ –ø—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î —á–µ—Ä–µ–∑ client
- –¢–æ–ª—å–∫–æ –≤—ã–∑–æ–≤ `recordAutoPaymentV2()` action
- –î–æ–±–∞–≤–ª–µ–Ω `GodModeActorSelector` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `Textarea` –¥–ª—è –ø—Ä–∏–º–µ—á–∞–Ω–∏–π

### –î—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∏–∑ V1)
- `/components/cars/add-car-dialog.tsx` - –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –∑–∞–∫—É–ø–∫–µ
- `/components/cars/add-expense-to-car-dialog.tsx` - –∑–∞–ø–∏—Å—å —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ auto_ledger
- `/components/auto-platform/add-auto-deal-dialog.tsx` - –∑–∞–ø–∏—Å—å –≤—ã—Ä—É—á–∫–∏ –≤ auto_ledger

---

## üìã –ú–∏–≥—Ä–∞—Ü–∏–∏

### `022_auto_schema_alignment_v2.sql` ‚úÖ
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ contact_id –≤ auto_clients
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ auto_deals (buyer_contact_id, total_paid, total_debt, etc.)
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ auto_payments (due_date, paid_amount, paid_date)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ constraints –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤

### `023_auto_record_payment_rpc_v2.sql` ‚úÖ
- –°–æ–∑–¥–∞–Ω–∏–µ `auto_record_payment_v2()` —Ñ—É–Ω–∫—Ü–∏–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å cashbox_operation_v2
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –ü–æ–ª–Ω—ã–π audit trail

### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–∏–∑ V1)
- –°–æ–∑–¥–∞–Ω–∏–µ auto_ledger —Ç–∞–±–ª–∏—Ü—ã
- –°–æ–∑–¥–∞–Ω–∏–µ auto_car_pnl view
- RPC —Ñ—É–Ω–∫—Ü–∏–∏ V1 (purchase, expense, deal, payment)

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –£—Ä–æ–≤–µ–Ω—å –ë–î
- ‚úÖ –í—Å–µ RPC —Ñ—É–Ω–∫—Ü–∏–∏ —Å `SECURITY DEFINER`
- ‚úÖ Row Level Security (RLS) –Ω–∞ auto_ledger
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π (deal, cashbox)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–∞–ª—é—Ç (currency match)
- ‚úÖ FOR UPDATE locks –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions

### –£—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ Server Actions —Ç–æ–ª—å–∫–æ
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (TypeScript)
- ‚úÖ Error handling —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### Audit Trail
- ‚úÖ –ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ audit_log_v2
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π actor_id (—á–µ—Ä–µ–∑ God Mode)
- ‚úÖ JSONB —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å—É–º–º—ã, —Å—Ç–∞—Ç—É—Å—ã, IDs)
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è audit –∑–∞–ø–∏—Å–µ–π

---

## üéØ –ö–µ–π—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ü—Ä–∏–Ω—è—Ç—å –ø–ª–∞—Ç–µ–∂ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí add-payment-dialog ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Å—Å—É, —Å—É–º–º—É, –∞–∫—Ç–æ—Ä–∞
  ‚Üì
recordAutoPaymentV2()
  ‚Üì
auto_record_payment_v2() RPC
  ‚Üì
1. cashbox_operation_v2() - –∞—Ç–æ–º–∞—Ä–Ω–æ —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é + –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
2. –û–±–Ω–æ–≤–ª—è–µ—Ç auto_payments
3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç total_paid/total_debt –≤ auto_deals
4. –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏
5. audit_log_v2
  ‚Üì
UI refresh ‚Üí –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã, —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏, –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã
```

### 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å P&L –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—é
```sql
SELECT * FROM auto_car_pnl WHERE car_id = '...';

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ó–∞–∫—É–ø–∫–∞: -$10,000
- –†–∞—Å—Ö–æ–¥—ã: -$2,500
- –í—ã—Ä—É—á–∫–∞: +$15,000
- –ü–ª–∞—Ç–µ–∂–∏: +$12,000
- –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: -$500 (–µ—â–µ $3,000 –¥–æ–ª–≥)
```

### 3. God Mode - –≤–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂ –æ—Ç –∏–º–µ–Ω–∏ –¥—Ä—É–≥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
```
1. –í–∫–ª—é—á–∏—Ç—å God Mode –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
2. –í—ã–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ GodModeActorSelector
3. –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂
  ‚Üì
audit_log_v2.actor_id = –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
audit_log_v2.new_data —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –¥–µ—Ç–∞–ª–∏
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Variant B V2

### vs Variant A (–∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
| –ê—Å–ø–µ–∫—Ç | Variant A | Variant B V2 |
|--------|-----------|--------------|
| –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å | ‚ùå –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | ‚úÖ RPC —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ |
| Cashbox –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | ‚ùå –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ | ‚úÖ cashbox_operation_v2 |
| God Mode | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| Audit trail | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω—ã–π | ‚úÖ –ü–æ–ª–Ω—ã–π |
| P&L tracking | ‚ùå –ù–µ—Ç | ‚úÖ auto_ledger + view |
| Race conditions | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã | ‚úÖ FOR UPDATE locks |

### vs Variant B V1 (–ø–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è)
| –ê—Å–ø–µ–∫—Ç | V1 | V2 |
|--------|----|----|
| Cashbox | ‚ö†Ô∏è –°—Ç–∞—Ä—ã–π cashbox_operation | ‚úÖ cashbox_operation_v2 |
| UI | ‚ö†Ô∏è –ü—Ä—è–º—ã–µ DB –æ–ø–µ—Ä–∞—Ü–∏–∏ | ‚úÖ –¢–æ–ª—å–∫–æ Server Actions |
| God Mode | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| Schema | ‚ö†Ô∏è –ë–∞–∑–æ–≤–∞—è | ‚úÖ –ü–æ–ª–Ω–∞—è (contacts, debt tracking) |
| Payments | ‚ö†Ô∏è –ü—Ä–æ—Å—Ç–æ–π | ‚úÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π |

---

## üöÄ –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å add-auto-deal-dialog –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RPC
- [ ] –î–æ–±–∞–≤–∏—Ç—å God Mode –≤ add-expense-to-car-dialog
- [ ] –°–æ–∑–¥–∞—Ç—å dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ P&L

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ
- [ ] RPC –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π (refund)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞–ª–æ–≥–æ–≤–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å—é

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ
- [ ] Multi-currency support –¥–ª—è —Å–¥–µ–ª–æ–∫
- [ ] –ö–æ–º–∏—Å—Å–∏–æ–Ω–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è —Å —Ä–∞—Å—á–µ—Ç–æ–º –ø—Ä–æ—Ñ–∏—Ç–∞
- [ ] Trade-in –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å P&L

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [x] –¢–∞–±–ª–∏—Ü–∞ auto_ledger —Å–æ–∑–¥–∞–Ω–∞
- [x] View auto_car_pnl —Å–æ–∑–¥–∞–Ω
- [x] auto_deals —Ä–∞—Å—à–∏—Ä–µ–Ω (total_paid, total_debt, contacts)
- [x] auto_payments —Ä–∞—Å—à–∏—Ä–µ–Ω (paid_amount, due_date)
- [x] auto_clients —Ä–∞—Å—à–∏—Ä–µ–Ω (contact_id)
- [x] RPC auto_record_payment_v2 —Å–æ–∑–¥–∞–Ω
- [x] Constraints –æ–±–Ω–æ–≤–ª–µ–Ω—ã (—Å—Ç–∞—Ç—É—Å—ã)
- [x] Indexes —Å–æ–∑–¥–∞–Ω—ã
- [x] RLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### Backend
- [x] Server Action recordAutoPaymentV2() —Å–æ–∑–¥–∞–Ω
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å cashbox_operation_v2
- [x] God Mode –ø–∞—Ä–∞–º–µ—Ç—Ä actorEmployeeId
- [x] Audit logging –≤ audit_log_v2
- [x] Error handling
- [x] TypeScript —Ç–∏–ø—ã

### Frontend
- [x] add-payment-dialog –ø–µ—Ä–µ–ø–∏—Å–∞–Ω
- [x] GodModeActorSelector –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- [x] Textarea –¥–ª—è –ø—Ä–∏–º–µ—á–∞–Ω–∏–π
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º
- [x] Loading states
- [x] Toast notifications

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] VARIANT_B_V2_COMPLETE.md
- [x] SQL –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- [x] Code comments –≤ critical –º–µ—Å—Ç–∞—Ö

---

## üéì –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –ü–æ—á–µ–º—É RPC, –∞ –Ω–µ –∫–ª–∏–µ–Ω—Ç?
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, race conditions, –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SECURITY DEFINER RPC –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –ü–æ—á–µ–º—É cashbox_operation_v2?
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–∞ –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, audit trail, –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é RPC —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### –ü–æ—á–µ–º—É auto_ledger?
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É –∞–≤—Ç–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ P&L
**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞-–ª–æ–≥ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (PURCHASE, EXPENSE, REVENUE, PAYMENT)

### –ü–æ—á–µ–º—É God Mode?
**–ü—Ä–æ–±–ª–µ–º–∞:** –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –≤–Ω–æ—Å–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—Ç –∏–º–µ–Ω–∏ –¥—Ä—É–≥–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–π
**–†–µ—à–µ–Ω–∏–µ:** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä actorEmployeeId + audit trail —Å —Ä–µ–∞–ª—å–Ω—ã–º –∞–∫—Ç–æ—Ä–æ–º

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å audit_log_v2 - —Ç–∞–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å auto_car_pnl - —Ç–∞–º –≤–∏–¥–Ω–∞ –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ –∞–≤—Ç–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cashbox transactions - —Ç–∞–º –≤–∏–¥–Ω—ã –∫–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**Variant B V2 –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! üéâ**
