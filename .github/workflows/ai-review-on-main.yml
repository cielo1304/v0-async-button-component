name: AI Review on main pushes

on:
  push:
    branches: [ "main" ]

permissions:
  issues: write
  contents: read

concurrency:
  group: ai-review-main
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Generate AI review and post to Issue (no checkout)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const head = context.payload.after;
            let base = context.payload.before;

            // If base is all zeros (rare, e.g. first push), use parent of head
            if (!base || /^0+$/.test(base)) {
              const commit = await github.rest.repos.getCommit({ owner, repo, ref: head });
              base = commit.data?.parents?.[0]?.sha;
            }

            if (!base) {
              core.warning("No base commit found; skipping AI review.");
              return;
            }

            // 1) Fetch diff between base..head (no checkout)
            // GitHub supports diff output via Accept header. :contentReference[oaicite:3]{index=3}
            const diffRes = await github.request('GET /repos/{owner}/{repo}/compare/{basehead}', {
              owner,
              repo,
              basehead: `${base}...${head}`,
              headers: { accept: 'application/vnd.github.v3.diff' }
            });

            let diff = typeof diffRes.data === 'string' ? diffRes.data : JSON.stringify(diffRes.data);

            // Clip to avoid huge prompts
            const MAX_CHARS = 180000;
            if (diff.length > MAX_CHARS) diff = diff.slice(0, MAX_CHARS) + "\n\n[DIFF TRUNCATED]";

            // 2) Call OpenAI Responses API :contentReference[oaicite:4]{index=4}
            const prompt = [
              "Ты — строгий senior reviewer и архитектор.",
              "Проанализируй diff изменений в main и дай ревью строго в формате:",
              "1) Критично (security/data loss)",
              "2) Важно (архитектура/поддерживаемость)",
              "3) Норм (стиль/мелочи)",
              "4) Конкретные правки (по возможности с короткими примерами кода)",
              "",
              "Контекст проекта:",
              "- Next.js App Router + Supabase",
              "- Миграции только add-only (ничего не удалять/не переименовывать без крайней нужды)",
              "- HR должности отдельно от RBAC ролей/permissions",
              "- GodMode через NEXT_PUBLIC_ACCESS_CONTROL_ENABLED",
              "",
              `Base: ${base}`,
              `Head: ${head}`,
              "",
              "DIFF:",
              diff
            ].join("\n");

            const openaiRes = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: "gpt-5",
                input: prompt,
                instructions: "Пиши по делу, пунктами. Максимум конкретики. Без воды."
              }),
            });

            if (!openaiRes.ok) {
              const t = await openaiRes.text();
              throw new Error(`OpenAI error ${openaiRes.status}: ${t}`);
            }

            const data = await openaiRes.json();
            let text = data.output_text;

            if (!text && Array.isArray(data.output)) {
              text = data.output
                .map(o => (o.content || []).map(c => c.text || "").join(""))
                .join("\n")
                .trim();
            }
            if (!text) text = "(AI review: empty response)";

            // 3) Find or create a single Issue "AI Review Log"
            const TITLE = "AI Review Log";
            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue in:title "${TITLE}"`,
              per_page: 10
            });

            let issueNumber;
            if (search.data.items.length > 0) {
              issueNumber = search.data.items[0].number;
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title: TITLE,
                body: "Сюда GitHub Actions будет автоматически добавлять AI-ревью после каждого push в main."
              });
              issueNumber = created.data.number;
            }

            // 4) Post comment
            const header = `## AI review for push to main\nBase: \`${base}\`\nHead: \`${head}\`\n`;
            const body = header + "\n" + text;

            const MAX_COMMENT = 60000;
            const finalBody = body.length > MAX_COMMENT ? body.slice(0, MAX_COMMENT) + "\n\n[COMMENT TRUNCATED]" : body;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: finalBody
            });
