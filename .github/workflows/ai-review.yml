name: AI Review

on:
  pull_request_target:
    types: [labeled, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  review:
    if: >
      github.event.pull_request.draft == false &&
      contains(github.event.pull_request.labels.*.name, 'ai-review')
    runs-on: ubuntu-latest

    steps:
      - name: Post AI review comment (no checkout)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            // 1) Fetch PR diff safely (no checkout)
            const diffRes = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}', {
              owner,
              repo,
              pull_number,
              headers: { accept: 'application/vnd.github.v3.diff' },
            });

            let diff = typeof diffRes.data === 'string' ? diffRes.data : JSON.stringify(diffRes.data);
            const MAX_CHARS = 180000;
            if (diff.length > MAX_CHARS) diff = diff.slice(0, MAX_CHARS) + "\n\n[DIFF TRUNCATED]";

            // 2) Call OpenAI Responses API
            const model = "gpt-5";
            const prompt = [
              "Ты — строгий senior reviewer и архитектор.",
              "Проанализируй diff PR и дай ревью строго в формате:",
              "1) Критично (security/data loss)",
              "2) Важно (архитектура/поддерживаемость)",
              "3) Норм (стиль/мелочи)",
              "4) Конкретные правки (по возможности с короткими примерами кода)",
              "",
              "Контекст проекта:",
              "- Next.js App Router + Supabase",
              "- Миграции только add-only (ничего не удалять/не переименовывать без нужды)",
              "- HR должности отдельно от RBAC ролей/permissions",
              "- GodMode через NEXT_PUBLIC_ACCESS_CONTROL_ENABLED",
              "",
              "DIFF:",
              diff
            ].join("\n");

            const openaiRes = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model,
                input: prompt,
                instructions: "Пиши по делу, пунктами. Максимум конкретики. Без воды."
              }),
            });

            if (!openaiRes.ok) {
              const t = await openaiRes.text();
              throw new Error(`OpenAI error ${openaiRes.status}: ${t}`);
            }

            const data = await openaiRes.json();

            // Robust text extraction
            let text = data.output_text;
            if (!text && Array.isArray(data.output)) {
              text = data.output
                .map(o => (o.content || []).map(c => c.text || "").join(""))
                .join("\n")
                .trim();
            }
            if (!text) text = "(AI review: empty response)";

            // Prevent too-long comments
            const MAX_COMMENT = 60000;
            if (text.length > MAX_COMMENT) text = text.slice(0, MAX_COMMENT) + "\n\n[COMMENT TRUNCATED]";

            // 3) Post comment to PR
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: text,
            });
